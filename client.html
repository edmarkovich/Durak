<html>
<head>
	<meta content="text/html"; charset="utf-8" http-equiv="content-type">
	<meta content="utf-8" http-equiv="encoding">
	<style>
		.card {
			border-style: solid;
			border-width: 1px;
			border-radius: 5px;
			border-color: black;
			padding: 5px;
			margin: 5px;
			width: 40px;
			float: left;
			text-align: center;
			position: absolute;
			transform-origin: top left;
		}

		.back {
			color: white;
			background: linear-gradient(to bottom right, gold, black);
		}

		.red {
			color: white;
			background: linear-gradient(to bottom right, black, 10%, darkred, 70%, black);
		}

		.black {
			color: white;
			background: linear-gradient(to bottom right, black, 10%, darkblue, 70%, black);
		}

		.defended {
			transform: rotate(20deg);
		}

		.attack {
			transform: rotate(0deg);
		}

		.trump {
			transform: rotate(270deg);
			z-index11: -1;
			animation-name: example;
			animation-duration: 1s;
		}

		@keyframes example{
			from {transform: rotate(180deg)}
			to {transform: rotate(270deg)}
		}


		.name {
			float: left;
			padding: 5px;
			margin: 10px;
			width: 50px;
		}

		.verb {
			float: right;
			padding: 5px;
			margin: 10px;
			width: 50px;
		}

		.player {
			border-radius: 5px;
			border-style: solid;
			border-color: white;
			padding: 20px;
			margin: 10px;
			color: gray;
			clear: both;
			overflow: auto;
			pointer-events: none;
			position: relative;
		}

		.turn {
			background-color: pink;
			border-color: green;
			pointer-events: auto;
		}

		.new_table {
			background-color: green;
			border-radius: 10px;
			display: inline-block;
			height: 500px;
			width: 500px;
		}

		.new_card {
			border-style: solid;
			border-width: 1px;
			border-radius: 5px;
			border-color: black;
			padding: 5px;
			margin: 5px;
			width: 40px;
			float: left;
			text-align: center;
			position: absolute;
			transform-origin: top left;

		}

		.new_trump {

		}

		.new_red {
			color: white;
			background: linear-gradient(to bottom right, black, 10%, darkred, 70%, black);
			tr1ansform: rotate(90deg);
			tra1nsition: transform 1s;
			tran1sform-style: preserve-3d;
		}
	</style>
</head>

<body>
<script>

function new_makeGameArea() {
	table = document.createElement('div')
	table.classList.add("new_table")
	document.body.appendChild(table);
	return table;
}



async function new_fly(element, to, speed, rotation) {

	keys = [
		{ transform: 'translate3d('+to[0]+'px,'+to[1]+'px,0px) '+rotation},  
	]
	animation = element.animate(keys, {
		duration: speed,
		iterations: 1,
		fill: "forwards",
		iterationComposite: "accumulate"
	})

	await animation.finished
	//animation.persist()

}

 async function new_placeDeckCard(table, trump_card, offset) {
	const deck_start=360

	card = document.createElement('div');
	card.innerHTML = "&nbsp;<br><br>&nbsp;"
	card.classList.add("new_card")
	card.classList.add("deck")
	table.appendChild(card);


	if (offset==0) {
		//card.classList.add("new_trump")		
		card.classList.add("red")
		await new_fly(card, [deck_start+30+(2*offset), 262], 200, "rotate3d(0,0,1,90deg) rotate3d(0,1,0,180deg)")
	} else {
		card.classList.add("back")
		await new_fly(card, [deck_start+(2*offset), 200], 50, "")
	}
}


async function new_placeDeck(table, trump_card, deck) {
	for (i=0; i<deck; i++) {
		await new_placeDeckCard(table, trump_card, i)
	}

}


async function new_deal_one_card(player, offset) {
	cards = document.getElementsByClassName("deck");
	top_card = cards[cards.length-1]
	top_card.classList.toggle("back")
	top_card.classList.toggle("deck")
	top_card.classList.toggle("new_red")
	
	await new_fly(top_card, [100+60*offset,400],200,"rotate3d(0,1,0,180deg)")
	//await new_fly(top_card, [100+60*offset,400,90],100)

}

async function new_deal_hand(player, cards) {
	for(i=0;i<cards;i++) {
		await new_deal_one_card(player, i)
	}
}


async function init() {
	table = new_makeGameArea();
	await new_placeDeck(table, "X", 20)
	await new_deal_hand("Ed", 6)
}

init()











let socket = new WebSocket("ws://192.168.1.13:5678")

mode = null;
turn = null;
player_name = null;
initialized = false;

function makePlayerArea(name) {
	player = document.createElement('div');
	player.setAttribute('class', name+" player")

	name_node = document.createElement('div')
	name_node.setAttribute('class', 'name')
	name_node.innerHTML = name
	player.appendChild(name_node);
	document.body.appendChild(player)
}


function updateGameArea(deck, trump, table) {
	populatePlayerArea("Table", table)

	if (deck == 0) {
		fake_deck = []
	} else {	
		fake_deck = Array.from({length: deck}).map(x => 'X');
		fake_deck[0] = trump; 
	}
	populatePlayerArea("Deck", fake_deck)
}

function getCardClass(name, card, sequence) {

	if (name!=player_name && name != "Table" && name != "Deck") {
		return "card back";
	}

	base = ""

	if (name == "Deck") {
		if (card[0] == 'X' || (card[0]>='0' && card[0]<='9')) {
			return "card back";
		} else {
			base = "trump ";
		}
	} 

	
	if (name == "Table") { base = (sequence % 2 == 1) ? 'defended ' : 'attack '}

	if (card[0] == "♥" || card[0] == "♦") {
		return base+"card red";
	}
	return base+"card black"
}

function populatePlayerArea(name, hand) {
	player = document.getElementsByClassName(name)[0]
  	player.setAttribute('class', name + " player") //Clear others

	//Get rid of existing cards
	var children = player.getElementsByClassName('card')
	for (child=children.length-1; child >=0; child--) {
		player.removeChild(children[child]);
	}
	children = player.getElementsByClassName('verb')
	for (child=children.length-1; child >=0; child--) {
		player.removeChild(children[child]);
	}

	for (card in hand) {
		span = document.createElement('div');
		marking = hand[card]


		span.style.left = 100 + (65* card);
		if (name == "Table"){ //} && card % 2 == 1) {
			span.style.left = 100 + (65*card/2);// - 35;
		} else if (name == "Deck" && card >= 1) {
			span.style.left = 133 + 5*card;
		} 


		span.setAttribute('class', getCardClass(name, marking, card))
		span.style.top = 0;
		span.setAttribute('onclick', 'send_card(this, \''+hand[card]+'\')')
		if (name != "Deck" || card == 0) {
			span.innerHTML = '<span>'
				+marking[0]
				+ "<br><B>" + marking.substring(1) + "</B><br>"
				+marking[0]
				+"</span>"
		} else {
			span.innerHTML = "<span>&nbsp;<br>X<br>&nbsp;</span>"
		}
		player.appendChild(span)
	}
}

function updatePrompt() {
	player = document.getElementsByClassName(turn)[0]
	if (mode == "First attack") {
		color = 'red';
		verb  = '';
	} else if (mode == "Add Cards") {
		color = 'red';
		verb  = 'pass';
	}
	else if (mode == "Defend") {
		color = 'blue';
		verb  = 'take';
	}

	player = document.getElementsByClassName(turn)[0]
	player.setAttribute('class', turn + " player turn")

	verb_node = document.createElement('div');
	verb_node.setAttribute('class', 'verb');
	verb_node.innerHTML = '<i onclick="send_verb(\''+verb+'\')">'+verb+"</i>"

	player.appendChild(verb_node);

}


socket.onopen = function(e) {
	//makeGameArea();
};

function makeGameArea(players) {
	makePlayerArea("Deck")

	for (id in players){
		name = players[id].name
		if (name != player_name) {
			makePlayerArea(name)
		}
	}

	hr = document.createElement('hr')
	hr.setAttribute("style", "clear: both;")
	document.body.appendChild(hr)

	makePlayerArea("Table")

	hr = document.createElement('hr')
	hr.setAttribute("style", "clear: both;")
	document.body.appendChild(hr)

	makePlayerArea(player_name)
}


socket.onmessage = function(event) {

	payload = JSON.parse(event.data)

	if ('game' in payload) {
		game = payload.game;

		if (!initialized) {
			makeGameArea(game.players)
			initialized = true;
		}

		for (id in game.players) {
			name = game.players[id].name
			hand = game.players[id].hand

			populatePlayerArea(name, hand)
		}

		updateGameArea(game.deck, game.trump, game.table);

	}
	if ('prompt' in payload) {
		mode = payload.prompt.prompt;
		if ('player' in payload.prompt) {
			turn = payload.prompt.player
			updatePrompt(player, prompt)
		} else {
			turn = null;
		}
	}
};

function send_card(element, card) {
	socket.send('{"action":"", "card":"'+card+'"}')
}

function send_verb(verb) {
	socket.send('{"action":"'+verb+'"}')
}

function login(name) {
	player_name = name;
	socket.send('{"action":"join","name":"'+player_name+'"}');
}

</script>
	<button onclick="login('Ed'); login('Jamie');">FF</button>
	<input type="text" id="command" value=''  />
	<button onclick="login(document.getElementById('command').value);">Login</button>
</body>

</html>
