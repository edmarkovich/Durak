<html>
    <head>
            <meta content="text/html"; charset="utf-8" http-equiv="content-type">
            <meta content="utf-8" http-equiv="encoding">
            <link rel="stylesheet" href="card.css">
            <script type="text/javascript" src="animations.js"></script>

    </head>
    <body>
        <script>

            state = {
                game: null
            }

            let socket = new WebSocket("ws://192.168.1.13:5678")
            socket.onopen = function(e) {
                state.my_name = prompt("Player Name"); 
                socket.send('{"action":"join","name":"'+state.my_name+'"}');
                //socket.send('{"action":"join","name":"Other"}');
            }

            socket.onmessage = async function(event) {
                payload = JSON.parse(event.data)
                console.log(payload)

                if ('prompt' in payload) {
                    state.mode = payload.prompt.prompt;
		            if ('player' in payload.prompt) {
                       glow_hand(payload.prompt.player == state.my_name)
                    }
                }

                if ('game' in payload) {
                    game = payload.game
                    if(!state.game) {
                        await new_deck()
                        await put_trump(game.trump)
                    }

                    table_to_add = game.table.filter(x => !state.game.table.includes(x) );
                    console.log(table_to_add)
                    for (i=0; i<table_to_add.length; i++) {
                        for (j=0; j<state.game.players.length; j++) {
                            if (state.game.players[j].hand.indexOf(table_to_add[i]) != -1) {
                                if (state.game.players[j].name == state.my_name) {
                                    play_own(table_to_add[i], state.mode);
                                } else {
                                    play_other(table_to_add[i], state.mode);
                                }
                            }
                        }
                    }

                    

                    if (game.table.length==0) {
                        for (id in game.players) {
                            name = game.players[id].name
                            hand = game.players[id].hand

                            if (name == state.my_name) {
                                await refill_my_hand(hand);
                            } else {
                                await refill_other_hand(hand.length)
                            }
                        } 
                    }
                    state.game = game
                    
                }
            }

            function send_card(card) {
	            socket.send('{"action":"", "card":"'+card+'"}')
            }
        </script>

    </body>
</html>