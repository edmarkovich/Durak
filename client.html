<html>
<head>
	<style>
		.card {
			border-style: solid;
			border-radius: 5px;
			padding: 5px;
			margin: 5px;
			width: 25px;
			float: left;
			text-align: center;
		}

		.name {
			float: left;
			padding: 5px;
			margin: 10px;
			width: 50px;
		}

		.verb {
			float: left;
			padding: 5px;
			margin: 10px;
			width: 50px;
		}

		.player {
			padding: 10px;
			color: gray;
			clear: both;
		}
	</style>
</head>

<body>
<script>

let socket = new WebSocket("ws://192.168.1.13:5678")

mode = null;
turn = null;

function makePlayerArea(name) {
	player = document.createElement('div');
	player.setAttribute('class', name+" player")

	name_node = document.createElement('div')
	name_node.setAttribute('class', 'name')
	name_node.innerHTML = name
	player.appendChild(name_node);
	document.body.appendChild(player)
}

function makeGameArea() {
	makePlayerArea("Deck")
	makePlayerArea("Table")

	hr = document.createElement('hr')
	hr.setAttribute("style", "clear: both;")
	document.body.appendChild(hr)
}

function updateGameArea(deck, trump, table) {
	populatePlayerArea("Table", table)
	populatePlayerArea("Deck", [deck, trump])
}

function populatePlayerArea(name, hand) {
	player = document.getElementsByClassName(name)[0]
  player.setAttribute('style', '')

	//Get rid of existing cards
	var children = player.getElementsByClassName('card')
	for (child=children.length-1; child >=0; child--) {
		player.removeChild(children[child]);
	}
	children = player.getElementsByClassName('verb')
	for (child=children.length-1; child >=0; child--) {
		player.removeChild(children[child]);
	}

	for (card in hand) {
		span = document.createElement('div');
		span.setAttribute('class', 'card')
		span.innerHTML = '<i onclick="send_card(\''+hand[card]+'\')">'+hand[card]+"</i>"
		player.appendChild(span)
	}
}

function updatePrompt() {
	player = document.getElementsByClassName(turn)[0]
	if (mode == "First attack") {
		color = 'red';
		verb  = '';
	} else if (mode == "Add Cards") {
		color = 'red';
		verb  = 'pass';
	}
	else if (mode == "Defend") {
		color = 'blue';
		verb  = 'take';
	}

	player = document.getElementsByClassName(turn)[0]
	player.setAttribute('style', 'color: '+color+';')

	verb_node = document.createElement('div');
	verb_node.setAttribute('class', 'verb');
	verb_node.innerHTML = '<i onclick="send_verb(\''+verb+'\')">'+verb+"</i>"

	player.appendChild(verb_node);

}

socket.onopen = function(e) {
	makeGameArea();
	makePlayerArea("Ed");
	makePlayerArea("Jon");
	makePlayerArea("Mike");
	makePlayerArea("Conway");

	log = document.createElement('div')
	log.setAttribute('style','clear: both; color: pink;')
	messages = document.createElement('div');
	messages.setAttribute("class", "messages")
	log.appendChild(messages);
	document.body.appendChild(log);

};

socket.onmessage = function(event) {
	var messages = document.getElementsByClassName('messages')[0]
	messages.innerHTML = event.data


	payload = JSON.parse(event.data)
	if ('game' in payload) {
		game = payload.game;
		for (id in game.players) {
			name = game.players[id].name
			hand = game.players[id].hand
			populatePlayerArea(name, hand)
		}
		updateGameArea(game.deck, game.trump, game.table);

	}
	if ('prompt' in payload) {
		mode = payload.prompt.prompt;
		if ('player' in payload.prompt) {
			turn = payload.prompt.player
			updatePrompt(player, prompt)
		} else {
			turn = null;
		}
	}
};

function send_card(card) {
	console.log("send", card)
	socket.send('{"action":"", "card":"'+card+'"}')
}

function send_verb(verb) {
	console.log("send", verb)
	socket.send('{"action":"'+verb+'"}')
}

function login() {
	socket.send('{"action":"join","name":"Ed"}')
	socket.send('{"action":"join","name":"Jon"}')
	socket.send('{"action":"join","name":"Mike"}')
	socket.send('{"action":"join","name":"Conway"}')
}

</script>
	<button onclick="login();">FF</button>
	<input type="text" id="command" value='{"action":"join","name":"Ed"}'  />
	<button onclick="socket.send(document.getElementById('command').value);">Eh</button>
</body>

</html>
